<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Password Reset Flow</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/sprint-1/1-3-password-reset-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user who forgot their password</asA>
    <iWant>to reset it via email</iWant>
    <soThat>I can regain access to my account</soThat>
    <tasks>
      <task id="1" ac-ref="AC1,AC2">
        <description>Implement forgot password UI flow</description>
        <subtasks>
          <subtask>Create ForgotPasswordPage widget (ConsumerWidget)</subtask>
          <subtask>Add "Forgot password?" text link to LoginPage</subtask>
          <subtask>Implement email input field with validation (email format check)</subtask>
          <subtask>Add "Send Reset Link" CTA button</subtask>
          <subtask>Create PasswordResetConfirmationPage with "Check your email" message</subtask>
          <subtask>Display reset link expiration notice (1 hour)</subtask>
          <subtask>Add "Didn't receive email?" helper text with resend option</subtask>
        </subtasks>
      </task>
      <task id="2" ac-ref="AC3">
        <description>Implement deep link handling for password reset</description>
        <subtasks>
          <subtask>Configure deep link scheme: lifeos://reset-password</subtask>
          <subtask>Implement DeepLinkHandler.handleResetPasswordLink(Uri uri)</subtask>
          <subtask>Extract reset token from deep link query parameters</subtask>
          <subtask>Navigate to ResetPasswordPage with token</subtask>
          <subtask>Handle expired/invalid token errors gracefully</subtask>
          <subtask>Configure URL schemes in iOS Info.plist and Android AndroidManifest.xml</subtask>
        </subtasks>
      </task>
      <task id="3" ac-ref="AC4,AC7">
        <description>Implement reset password UI and validation</description>
        <subtasks>
          <subtask>Create ResetPasswordPage widget (ConsumerStatefulWidget)</subtask>
          <subtask>Implement new password input field with visibility toggle</subtask>
          <subtask>Implement confirm password input field</subtask>
          <subtask>Add real-time password strength indicator (weak/medium/strong)</subtask>
          <subtask>Display password requirements: 8+ chars, 1 uppercase, 1 number, 1 special char</subtask>
          <subtask>Validate password match (password === confirmPassword)</subtask>
          <subtask>Add "Reset Password" CTA button (disabled until valid)</subtask>
        </subtasks>
      </task>
      <task id="4" ac-ref="AC2,AC5,AC6,AC7">
        <description>Implement password reset use cases</description>
        <subtasks>
          <subtask>Create RequestPasswordResetUseCase using Supabase auth.resetPasswordForEmail()</subtask>
          <subtask>Create UpdatePasswordUseCase using Supabase auth.updateUser()</subtask>
          <subtask>Implement ResetPasswordRepository interface</subtask>
          <subtask>Handle Supabase reset token validation</subtask>
          <subtask>Implement auto-login after successful password reset</subtask>
          <subtask>Verify old password invalidated (Supabase handles automatically)</subtask>
        </subtasks>
      </task>
      <task id="5" ac-ref="AC7">
        <description>Implement comprehensive error handling</description>
        <subtasks>
          <subtask>Handle "Email not found" error with user-friendly message</subtask>
          <subtask>Handle "Link expired" error with option to request new link</subtask>
          <subtask>Handle "Weak password" validation errors</subtask>
          <subtask>Handle "Password mismatch" errors</subtask>
          <subtask>Handle network errors with retry option</subtask>
          <subtask>Handle rate limiting (too many reset requests)</subtask>
          <subtask>Display all errors in consistent UI pattern (SnackBar or error text)</subtask>
        </subtasks>
      </task>
      <task id="6" ac-ref="AC2">
        <description>Configure Supabase email template</description>
        <subtasks>
          <subtask>Customize password reset email template in Supabase Dashboard</subtask>
          <subtask>Add LifeOS branding (logo, colors)</subtask>
          <subtask>Configure reset link URL: lifeos://reset-password?token={{.Token}}</subtask>
          <subtask>Include 1-hour expiration notice in email body</subtask>
          <subtask>Add support email contact for help</subtask>
          <subtask>Test email delivery in staging environment</subtask>
        </subtasks>
      </task>
      <task id="7" ac-ref="ALL">
        <description>Write comprehensive tests</description>
        <subtasks>
          <subtask>Unit tests: RequestPasswordResetUseCase, UpdatePasswordUseCase</subtask>
          <subtask>Unit tests: Password validation logic (strength, match, requirements)</subtask>
          <subtask>Unit tests: Deep link parsing and token extraction</subtask>
          <subtask>Widget tests: ForgotPasswordPage email input and validation</subtask>
          <subtask>Widget tests: ResetPasswordPage password fields and strength indicator</subtask>
          <subtask>Widget tests: Error handling for all error scenarios</subtask>
          <subtask>Integration test: Complete password reset flow (request → email → reset → login)</subtask>
          <subtask>Integration test: Expired token handling</subtask>
          <subtask>Achieve 80%+ code coverage</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <text>User can request password reset from login screen</text>
      <priority>P0</priority>
    </criterion>
    <criterion id="AC2">
      <text>Email sent with reset link (expires in 1 hour)</text>
      <priority>P0</priority>
    </criterion>
    <criterion id="AC3">
      <text>Reset link opens password change screen (deep link)</text>
      <priority>P0</priority>
    </criterion>
    <criterion id="AC4">
      <text>User can set new password (same validation as registration)</text>
      <priority>P0</priority>
    </criterion>
    <criterion id="AC5">
      <text>User auto-logged in after successful password reset</text>
      <priority>P0</priority>
    </criterion>
    <criterion id="AC6">
      <text>Old password invalidated after reset</text>
      <priority>P0</priority>
    </criterion>
    <criterion id="AC7">
      <text>Error handling: Email not found, link expired, weak new password</text>
      <priority>P0</priority>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/ecosystem/prd.md</path>
        <title>LifeOS - Product Requirements Document</title>
        <section>FR3: Password reset via email verification</section>
        <snippet>Users can reset passwords via email verification. Reset link must expire after 1 hour for security. User should be auto-logged in after successful reset.</snippet>
      </doc>
      <doc>
        <path>docs/ecosystem/prd.md</path>
        <title>LifeOS - Product Requirements Document</title>
        <section>NFR-S2: Authentication & Sessions</section>
        <snippet>Password requirements: Min 8 characters, 1 uppercase, 1 number, 1 special char. Session expiration: 30 days of inactivity. Social auth: OAuth 2.0 (Google, Apple).</snippet>
      </doc>
      <doc>
        <path>docs/ecosystem/epics.md</path>
        <title>Epic 1: Core Platform Foundation - Story 1.3</title>
        <section>Story 1.3: Password Reset Flow</section>
        <snippet>Complete password reset flow with email verification, deep linking, and automatic login. Prerequisites: Story 1.1 (user accounts), Story 1.2 (login flow). Supabase handles reset token generation and validation.</snippet>
      </doc>
      <doc>
        <path>docs/ecosystem/architecture.md</path>
        <title>LifeOS - System Architecture</title>
        <section>Hybrid Architecture (D1)</section>
        <snippet>Feature-first architecture with clean architecture layers (presentation/domain/data). Auth module located at features/auth/. Use Riverpod for state management and go_router for declarative routing with deep linking support.</snippet>
      </doc>
      <doc>
        <path>docs/ecosystem/security-architecture.md</path>
        <title>LifeOS - Security Architecture</title>
        <section>Authentication & Authorization</section>
        <snippet>Supabase Auth provides secure password storage using bcrypt. Reset tokens expire after 1 hour (default). Password validation enforced: min 8 chars, uppercase, lowercase, number, special character. Rate limiting: max 5 reset requests per hour per email.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/sprint-1/1-3-password-reset-flow.md</path>
        <title>Story 1.3: Password Reset Flow</title>
        <section>Technical Implementation</section>
        <snippet>Use Supabase auth.resetPasswordForEmail() with redirectTo: 'lifeos://reset-password'. Deep link handler extracts token and navigates to ResetPasswordPage. Use auth.updateUser() to set new password, which auto-invalidates old password and maintains session.</snippet>
      </doc>
    </docs>
    <code>
      <note>Auth module partially exists from Story 1.1 and 1.2. Extend with password reset functionality. Reuse existing auth patterns, repositories, and Riverpod providers from login implementation.</note>
      <reference>
        <path>lib/features/auth/presentation/pages/login_page.dart</path>
        <description>Existing login page - add "Forgot password?" link</description>
      </reference>
      <reference>
        <path>lib/features/auth/domain/repositories/auth_repository.dart</path>
        <description>Existing auth repository - extend with resetPassword methods</description>
      </reference>
      <reference>
        <path>lib/core/routing/deep_link_handler.dart</path>
        <description>Deep link handler - add password reset route handling</description>
      </reference>
    </code>
    <dependencies>
      <flutter>
        <sdk>3.38+</sdk>
        <dart>3.10+</dart>
      </flutter>
      <packages>
        <package name="flutter_riverpod" version="^3.0.0" usage="State management for password reset flow" />
        <package name="riverpod_annotation" version="^3.0.0" usage="Code generation for providers" />
        <package name="supabase_flutter" version="^2.0.0" usage="Supabase Auth for password reset (resetPasswordForEmail, updateUser)" />
        <package name="go_router" version="^13.0.0" usage="Declarative routing and deep link handling" />
        <package name="flutter_secure_storage" version="^9.0.0" usage="Secure storage for auth tokens" />
        <package name="email_validator" version="^2.1.17" usage="Email format validation" />
        <package name="flutter_test" version="sdk" usage="Unit and widget testing framework" />
        <package name="integration_test" version="sdk" usage="End-to-end testing framework" />
        <package name="mockito" version="^5.4.0" usage="Mocking dependencies in tests" />
      </packages>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="ARCH-1" type="architectural">
      <description>Must follow Hybrid Architecture pattern (D1)</description>
      <details>Extend existing auth feature structure at lib/features/auth/ with presentation/, domain/, and data/ layers. Reuse existing AuthRepository and add password reset methods. Use clean architecture separation of concerns.</details>
    </constraint>
    <constraint id="ARCH-2" type="architectural">
      <description>Use Riverpod for state management (D1, D6)</description>
      <details>Create providers for password reset flow following feature-first structure. Providers should be in auth/presentation/providers/. Reuse existing auth providers where possible.</details>
    </constraint>
    <constraint id="ARCH-3" type="architectural">
      <description>Use go_router for deep link handling</description>
      <details>Configure deep link route for password reset: lifeos://reset-password. Extract token from query parameters. Navigate to ResetPasswordPage with token. Handle invalid/expired tokens gracefully.</details>
    </constraint>
    <constraint id="SEC-1" type="security">
      <description>Password validation must match registration requirements</description>
      <details>Min 8 characters, at least 1 uppercase letter, 1 lowercase letter, 1 number, 1 special character. Display real-time validation feedback. Enforce same rules as Story 1.1 registration.</details>
    </constraint>
    <constraint id="SEC-2" type="security">
      <description>Reset link expires in 1 hour</description>
      <details>Supabase default expiration is 1 hour (3600 seconds). Display expiration notice in email and confirmation screen. Handle expired token error with clear message and option to request new link.</details>
    </constraint>
    <constraint id="SEC-3" type="security">
      <description>Rate limiting for reset requests</description>
      <details>Supabase enforces rate limiting (max 5 requests/hour per email). Handle rate limit errors gracefully with user-friendly message: "Too many reset requests. Please try again in 1 hour."</details>
    </constraint>
    <constraint id="SEC-4" type="security">
      <description>Old password must be invalidated</description>
      <details>Supabase auth.updateUser() automatically invalidates old password. No additional implementation needed, but verify in integration tests that old password cannot be used after reset.</details>
    </constraint>
    <constraint id="SEC-5" type="security">
      <description>Auto-login after successful reset</description>
      <details>After auth.updateUser() succeeds, user session is automatically maintained (no need to call signIn again). Navigate to home screen and display success message: "Password reset successfully! Logging you in..."</details>
    </constraint>
    <constraint id="UX-1" type="ux">
      <description>Clear user feedback at every step</description>
      <details>Display confirmation after reset email sent: "Check your email". Show loading states during API calls. Display success message after password reset. Provide clear error messages for all failure scenarios.</details>
    </constraint>
    <constraint id="UX-2" type="ux">
      <description>Password strength indicator</description>
      <details>Display real-time password strength indicator (weak/medium/strong) as user types. Show all requirements with checkmarks (✓) when met. Disable submit button until all requirements satisfied.</details>
    </constraint>
    <constraint id="UX-3" type="ux">
      <description>Email template customization</description>
      <details>Customize Supabase email template with LifeOS branding (logo, colors #1E3A8A Deep Blue, #14B8A6 Teal). Include clear CTA button, 1-hour expiration notice, and support contact. Test email rendering across providers (Gmail, Outlook, Apple Mail).</details>
    </constraint>
    <constraint id="PERF-1" type="performance">
      <description>Email delivery within 3 seconds</description>
      <details>Supabase should send reset email within 3 seconds of request. Show loading indicator during send. If timeout occurs (>10s), display error: "Email could not be sent. Please try again."</details>
    </constraint>
    <constraint id="PERF-2" type="performance">
      <description>Password update completes within 1 second</description>
      <details>Supabase auth.updateUser() should complete in <1s. Show loading indicator during update. If timeout occurs (>5s), display error and allow retry.</details>
    </constraint>
    <constraint id="TEST-1" type="testing">
      <description>80%+ code coverage required</description>
      <details>Follow 70/20/10 testing pyramid. Unit tests for use cases and validation logic, widget tests for UI components, integration test for complete flow. All acceptance criteria must have test coverage.</details>
    </constraint>
    <constraint id="DEP-1" type="dependency">
      <description>Prerequisites: Story 1.1 and 1.2</description>
      <details>Story 1.1 provides user registration and accounts. Story 1.2 provides login flow and session management. Password reset reuses existing auth infrastructure and login flow for auto-login after reset.</details>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>RequestPasswordResetUseCase</name>
      <kind>use-case</kind>
      <signature>
        abstract class RequestPasswordResetUseCase {
          Future&lt;Result&lt;void&gt;&gt; call(String email);
        }
      </signature>
      <path>lib/features/auth/domain/usecases/request_password_reset_usecase.dart</path>
      <notes>Returns Result&lt;void&gt; pattern (Success/Failure). Calls Supabase auth.resetPasswordForEmail(email, redirectTo: 'lifeos://reset-password'). Handles email not found and rate limiting errors.</notes>
    </interface>
    <interface>
      <name>UpdatePasswordUseCase</name>
      <kind>use-case</kind>
      <signature>
        abstract class UpdatePasswordUseCase {
          Future&lt;Result&lt;void&gt;&gt; call({
            required String newPassword,
          });
        }
      </signature>
      <path>lib/features/auth/domain/usecases/update_password_usecase.dart</path>
      <notes>Returns Result&lt;void&gt; pattern. Calls Supabase auth.updateUser(UserAttributes(password: newPassword)). Validates password meets requirements before calling API. Maintains user session (auto-login).</notes>
    </interface>
    <interface>
      <name>ValidatePasswordUseCase</name>
      <kind>use-case</kind>
      <signature>
        abstract class ValidatePasswordUseCase {
          PasswordValidationResult call(String password);
        }

        class PasswordValidationResult {
          final bool isValid;
          final bool hasMinLength;      // 8+ chars
          final bool hasUppercase;      // A-Z
          final bool hasLowercase;      // a-z
          final bool hasNumber;         // 0-9
          final bool hasSpecialChar;    // !@#$%^&amp;*
          final PasswordStrength strength; // weak/medium/strong
        }
      </signature>
      <path>lib/features/auth/domain/usecases/validate_password_usecase.dart</path>
      <notes>Reuse from Story 1.1 registration if already implemented. Returns validation result with detailed breakdown for UI display. Calculates strength based on criteria met.</notes>
    </interface>
    <interface>
      <name>AuthRepository</name>
      <kind>repository</kind>
      <signature>
        abstract class AuthRepository {
          // Existing methods from Story 1.1, 1.2
          Future&lt;Result&lt;User&gt;&gt; signUp(String email, String password);
          Future&lt;Result&lt;User&gt;&gt; signIn(String email, String password);
          Future&lt;Result&lt;void&gt;&gt; signOut();

          // New methods for Story 1.3
          Future&lt;Result&lt;void&gt;&gt; requestPasswordReset(String email);
          Future&lt;Result&lt;void&gt;&gt; updatePassword(String newPassword);
        }
      </signature>
      <path>lib/features/auth/domain/repositories/auth_repository.dart</path>
      <notes>Extend existing AuthRepository interface with password reset methods. Implemented by AuthRepositoryImpl using Supabase client.</notes>
    </interface>
    <interface>
      <name>DeepLinkHandler</name>
      <kind>service</kind>
      <signature>
        class DeepLinkHandler {
          void handleDeepLink(Uri uri) {
            if (uri.path == '/reset-password' || uri.host == 'reset-password') {
              final token = uri.queryParameters['token'];
              if (token != null) {
                _navigateToResetPassword(token);
              } else {
                _handleInvalidLink();
              }
            }
          }
        }
      </signature>
      <path>lib/core/routing/deep_link_handler.dart</path>
      <notes>Extend existing DeepLinkHandler (if exists from other stories) or create new. Integrate with go_router. Handle both lifeos://reset-password and https://lifeos.app/reset-password for web compatibility.</notes>
    </interface>
    <interface>
      <name>ForgotPasswordPage</name>
      <kind>page</kind>
      <signature>
        class ForgotPasswordPage extends ConsumerWidget {
          @override
          Widget build(BuildContext context, WidgetRef ref) {
            // Email input field
            // Send Reset Link button
            // Back to login link
          }
        }
      </signature>
      <path>lib/features/auth/presentation/pages/forgot_password_page.dart</path>
      <notes>Modal or full-page (based on design). Email input with validation. Display confirmation after email sent. Handle errors with SnackBar.</notes>
    </interface>
    <interface>
      <name>ResetPasswordPage</name>
      <kind>page</kind>
      <signature>
        class ResetPasswordPage extends ConsumerStatefulWidget {
          final String token;

          @override
          Widget build(BuildContext context, WidgetRef ref) {
            // New password field with visibility toggle
            // Confirm password field
            // Password strength indicator
            // Requirements checklist
            // Reset Password button
          }
        }
      </signature>
      <path>lib/features/auth/presentation/pages/reset_password_page.dart</path>
      <notes>Token passed as route parameter. Display password requirements with checkmarks. Real-time validation. Navigate to home after successful reset with success message.</notes>
    </interface>
    <interface>
      <name>Supabase Email Template</name>
      <kind>email-template</kind>
      <signature>
        Subject: Reset Your LifeOS Password

        Body:
        Hi there!

        You requested to reset your password for your LifeOS account.

        Click the button below to reset your password:

        [Reset Password Button] → lifeos://reset-password?token={{.Token}}

        This link will expire in 1 hour for security reasons.

        If you didn't request this, you can safely ignore this email.

        Need help? Contact support@lifeos.app

        --
        LifeOS Team
      </signature>
      <path>Supabase Dashboard → Authentication → Email Templates → Reset Password</path>
      <notes>Customize in Supabase Dashboard (not code). Use LifeOS branding colors. Test across email clients. Ensure mobile link handling works.</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Follow 70/20/10 testing pyramid: 70% unit tests (use cases, validation logic, repositories), 20% widget tests (UI components, form validation, error states), 10% integration tests (end-to-end flow with Supabase). Use flutter_test for unit/widget tests, integration_test for E2E. Mock Supabase client with mockito. Target 80%+ code coverage. All acceptance criteria must have test coverage.
    </standards>
    <locations>
      <location>test/features/auth/domain/usecases/</location>
      <location>test/features/auth/data/repositories/</location>
      <location>test/features/auth/presentation/pages/</location>
      <location>test/core/routing/deep_link_handler_test.dart</location>
      <location>integration_test/features/auth/password_reset_flow_test.dart</location>
    </locations>
    <ideas>
      <test-idea ac-ref="AC1,AC2">
        <description>Unit test: RequestPasswordResetUseCase success case</description>
        <approach>Mock AuthRepository. Call use case with valid email. Verify repository.requestPasswordReset() called. Assert Success result returned.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Unit test: RequestPasswordResetUseCase email not found error</description>
        <approach>Mock repository to throw AuthException with "User not found" code. Assert Failure result returned with user-friendly error message.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Unit test: RequestPasswordResetUseCase rate limit error</description>
        <approach>Mock repository to throw RateLimitException. Assert Failure result with "Too many requests" error message.</approach>
      </test-idea>
      <test-idea ac-ref="AC4">
        <description>Unit test: ValidatePasswordUseCase - all requirements met</description>
        <approach>Pass password "Test123!@#". Verify hasMinLength=true, hasUppercase=true, hasLowercase=true, hasNumber=true, hasSpecialChar=true, isValid=true, strength=strong.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Unit test: ValidatePasswordUseCase - weak password</description>
        <approach>Pass password "test". Verify hasMinLength=false, missing uppercase/number/special, isValid=false, strength=weak.</approach>
      </test-idea>
      <test-idea ac-ref="AC5,AC6">
        <description>Unit test: UpdatePasswordUseCase success and auto-login</description>
        <approach>Mock AuthRepository. Call use case with valid password. Verify repository.updatePassword() called. Assert Success result. Verify session maintained (no signOut called).</approach>
      </test-idea>
      <test-idea ac-ref="AC3">
        <description>Unit test: DeepLinkHandler extracts reset token</description>
        <approach>Create Uri "lifeos://reset-password?token=abc123". Call handleDeepLink(uri). Verify navigation to ResetPasswordPage with token="abc123".</approach>
      </test-idea>
      <test-idea ac-ref="AC3,AC7">
        <description>Unit test: DeepLinkHandler handles missing token</description>
        <approach>Create Uri "lifeos://reset-password" without token. Call handleDeepLink(uri). Verify error handler called with "Invalid reset link" message.</approach>
      </test-idea>
      <test-idea ac-ref="AC1">
        <description>Widget test: ForgotPasswordPage displays email input</description>
        <approach>Render ForgotPasswordPage. Find email TextField. Verify hint text "Enter your email". Verify Send button present.</approach>
      </test-idea>
      <test-idea ac-ref="AC1,AC2">
        <description>Widget test: ForgotPasswordPage sends reset email</description>
        <approach>Render page. Enter valid email. Tap Send button. Verify loading indicator shown. Mock successful response. Verify confirmation screen displayed.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Widget test: ForgotPasswordPage displays email validation error</description>
        <approach>Enter invalid email "notanemail". Tap Send button. Verify error message "Please enter a valid email address" displayed.</approach>
      </test-idea>
      <test-idea ac-ref="AC4">
        <description>Widget test: ResetPasswordPage displays password requirements</description>
        <approach>Render ResetPasswordPage. Verify requirements list displayed: "8+ characters", "1 uppercase", "1 number", "1 special character". Verify all unchecked initially.</approach>
      </test-idea>
      <test-idea ac-ref="AC4">
        <description>Widget test: ResetPasswordPage updates requirements checklist</description>
        <approach>Enter password "Test1". Verify hasMinLength and hasUppercase checked. Add "!" to make "Test1!". Verify hasSpecialChar checked. Verify strength indicator updates.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Widget test: ResetPasswordPage displays password mismatch error</description>
        <approach>Enter password "Test123!" and confirmPassword "Test456!". Tap Reset button. Verify error "Passwords do not match" displayed.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Widget test: ResetPasswordPage handles expired token error</description>
        <approach>Mock UpdatePasswordUseCase to return Failure with "Token expired" error. Tap Reset button. Verify error message displayed with "Request new link" button.</approach>
      </test-idea>
      <test-idea ac-ref="AC5">
        <description>Widget test: ResetPasswordPage displays success message</description>
        <approach>Enter valid matching passwords. Mock successful update. Tap Reset button. Verify success message "Password reset successfully! Logging you in..." displayed. Verify navigation to home.</approach>
      </test-idea>
      <test-idea ac-ref="ALL">
        <description>Integration test: Complete password reset flow</description>
        <approach>1. Navigate to LoginPage. 2. Tap "Forgot password?". 3. Enter email, tap Send. 4. Verify email sent (mock email service). 5. Simulate deep link with token. 6. Verify ResetPasswordPage opens. 7. Enter new password "NewTest123!". 8. Tap Reset Password. 9. Verify password updated in Supabase. 10. Verify auto-login (session exists). 11. Verify navigation to home. 12. Attempt login with old password (should fail). 13. Attempt login with new password (should succeed).</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Integration test: Expired token handling</description>
        <approach>1. Request password reset. 2. Simulate token expiration (mock time or use expired token). 3. Attempt to reset password with expired token. 4. Verify error message displayed. 5. Tap "Request new link". 6. Verify ForgotPasswordPage opens. 7. Resend email. 8. Use new token and complete reset successfully.</approach>
      </test-idea>
      <test-idea ac-ref="AC7">
        <description>Integration test: Network error handling and retry</description>
        <approach>1. Navigate to ForgotPasswordPage. 2. Mock network error. 3. Enter email, tap Send. 4. Verify error "Connection failed. Please try again." displayed. 5. Tap Retry button. 6. Mock successful response. 7. Verify email sent confirmation.</approach>
      </test-idea>
    </ideas>
  </tests>
</story-context>
